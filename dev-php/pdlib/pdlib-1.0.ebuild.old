EAPI="7"

PHP_EXT_NAME="pdlib"
USE_PHP="php5-6 php7-0 php7-1 php7-2 php7-3"

inherit cmake-utils php-ext-source-r3

DESCRIPTION="PHP bindings for libvirt"
HOMEPAGE="https://github.com/goodspb/${PN}"
SRC_URI="https://github.com/goodspb/${PN}/archive/v${PV}.tar.gz -> ${P}.tar.gz"

LICENSE="LGPL-2.1"
SLOT="0"
KEYWORDS="~amd64"
IUSE="doc"

RDEPEND="sci-libs/dlib"
DEPEND="${RDEPEND}"

RESTRICT="test"

src_prepare() {
	php-ext-source-r3_src_prepare
	local slot
	for slot in $(php_get_slots); do
		BUILD_DIR="${WORKDIR}/${slot}"

        	php_init_slot_env ${slot}

		cmake-utils_src_prepare
	done
}

src_configure() {
	local slot
	for slot in $(php_get_slots); do
		BUILD_DIR="${WORKDIR}/${slot}"

		php_init_slot_env ${slot} # Get $EXT_DIR for LIB_INSTALL_DIR

		mycmakeargs=(
			-DBUILD_SHARED_LIBS=ON
			-DBUILD_TESTS=Off
			-DPHP_INSTALL_DIR="${EXT_DIR#$EPREFIX}"
			-DPHP_INCLUDE_DIR="/usr/$(get_libdir)/${slot}/include/php"
			-DCMAKE_SKIP_RPATH="TRUE"
		)

		cmake-utils_src_configure
	done;
}

src_compile() {
	local slot
	for slot in $(php_get_slots); do
		BUILD_DIR="${WORKDIR}/${slot}"

		php_init_slot_env ${slot}

		cmake-utils_src_compile
	done
}

src_install() {
	cmake-utils_src_install

	local slot
	for slot in $(php_get_slots); do
		BUILD_DIR="${WORKDIR}/${slot}"
		php_init_slot_env ${slot}

		php-ext-source-r3_createinifiles
	done
}
